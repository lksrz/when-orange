<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Verify E2EE and Grid Height Fixes</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
				background: #f5f5f5;
			}
			.test-section {
				background: white;
				margin: 20px 0;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.grid-test {
				height: 100vh;
				display: flex;
				flex-direction: column;
				background: white;
			}
			.participant-area {
				position: relative;
				flex: 1;
				min-height: 0;
				height: calc(100vh - 5rem - env(safe-area-inset-bottom));
				background: #e2e8f0;
				border: 2px solid #3b82f6;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 18px;
				font-weight: bold;
			}
			.bottom-toolbar {
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				height: 5rem;
				background: #1f2937;
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
			}
			.status {
				padding: 10px;
				margin: 10px 0;
				border-radius: 4px;
			}
			.success {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.warning {
				background: #fff3cd;
				color: #856404;
				border: 1px solid #ffeaa7;
			}
			.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.test-button {
				background: #3b82f6;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 6px;
				cursor: pointer;
				margin: 5px;
			}
			.test-button:hover {
				background: #2563eb;
			}
			.console-output {
				background: #1f2937;
				color: #f3f4f6;
				padding: 15px;
				border-radius: 6px;
				font-family: 'Courier New', monospace;
				max-height: 200px;
				overflow-y: auto;
				white-space: pre-wrap;
			}
		</style>
	</head>
	<body>
		<h1>üß™ When-Orange Fixes Verification</h1>

		<div class="test-section">
			<h2>1. Grid Height Fix Test</h2>
			<p>
				The participant area should occupy exactly the space above the bottom
				toolbar (5rem = 80px).
			</p>

			<div class="grid-test">
				<div class="participant-area">
					üé• Participant Grid Area<br />
					This should stop exactly where the toolbar begins
				</div>
				<div class="bottom-toolbar">üéõÔ∏è Bottom Toolbar (5rem height)</div>
			</div>

			<div id="gridStatus" class="status warning">
				Test the layout above. The blue area should not overlap with the dark
				toolbar.
			</div>
		</div>

		<div class="test-section">
			<h2>2. E2EE Worker Readiness Test</h2>
			<p>Test if E2EE worker initialization is working correctly.</p>

			<button class="test-button" onclick="testE2EEWorker()">
				Test E2EE Worker
			</button>
			<button class="test-button" onclick="clearConsole()">
				Clear Console
			</button>

			<div id="e2eeStatus" class="status warning">
				Click "Test E2EE Worker" to verify worker initialization.
			</div>

			<h3>Console Output:</h3>
			<div id="consoleOutput" class="console-output">Waiting for test...</div>
		</div>

		<div class="test-section">
			<h2>3. Open Real Application</h2>
			<p>Test the actual application with both fixes:</p>

			<button class="test-button" onclick="openApp()">
				Open When-Orange App
			</button>

			<div class="status warning">
				<strong>Testing Steps:</strong><br />
				1. Open the app in multiple browser tabs/windows<br />
				2. Join a room with E2EE enabled<br />
				3. Verify grid height is correct<br />
				4. Verify video/audio works between participants<br />
				5. Check console for proper E2EE logs<br />
				6. Verify "ENCRYPTED" indicator appears only when ready
			</div>
		</div>

		<script>
			let originalConsoleLog = console.log
			let originalConsoleWarn = console.warn
			let originalConsoleError = console.error

			function captureConsole() {
				const output = document.getElementById('consoleOutput')

				console.log = function (...args) {
					output.textContent += 'üîç LOG: ' + args.join(' ') + '\n'
					output.scrollTop = output.scrollHeight
					originalConsoleLog.apply(console, arguments)
				}

				console.warn = function (...args) {
					output.textContent += '‚ö†Ô∏è WARN: ' + args.join(' ') + '\n'
					output.scrollTop = output.scrollHeight
					originalConsoleWarn.apply(console, arguments)
				}

				console.error = function (...args) {
					output.textContent += '‚ùå ERROR: ' + args.join(' ') + '\n'
					output.scrollTop = output.scrollHeight
					originalConsoleError.apply(console, arguments)
				}
			}

			function clearConsole() {
				document.getElementById('consoleOutput').textContent = ''
			}

			function testE2EEWorker() {
				const status = document.getElementById('e2eeStatus')
				status.className = 'status warning'
				status.textContent = 'Testing E2EE worker initialization...'

				captureConsole()

				console.log('üîê Starting E2EE worker test...')

				try {
					// Simulate E2EE worker creation
					console.log('üîê Creating E2EE worker...')
					const worker = new Worker('/e2ee/worker.js')

					let workerReady = false
					let timeout = setTimeout(() => {
						if (!workerReady) {
							console.error('üîê Worker failed to become ready within 5 seconds')
							status.className = 'status error'
							status.textContent = 'E2EE Worker test FAILED - Timeout'
						}
					}, 5000)

					worker.addEventListener('message', (event) => {
						console.log('üîê Worker message:', event.data)

						if (event.data.type === 'workerReady') {
							workerReady = true
							clearTimeout(timeout)
							console.log('üîê Worker is ready!')
							status.className = 'status success'
							status.textContent = 'E2EE Worker test PASSED - Worker ready'

							// Test worker capabilities
							console.log('üîê Testing worker initialization...')
							worker.postMessage({
								type: 'initializeAndCreateGroup',
								id: 'test-user',
							})
						}
					})

					worker.addEventListener('error', (error) => {
						console.error('üîê Worker error:', error)
						status.className = 'status error'
						status.textContent = 'E2EE Worker test FAILED - Worker error'
					})
				} catch (error) {
					console.error('üîê Failed to create worker:', error)
					status.className = 'status error'
					status.textContent =
						'E2EE Worker test FAILED - Could not create worker'
				}
			}

			function openApp() {
				window.open('http://localhost:8787/', '_blank')
			}

			// Test grid height on page load
			window.addEventListener('load', () => {
				const participantArea = document.querySelector('.participant-area')
				const toolbar = document.querySelector('.bottom-toolbar')
				const gridStatus = document.getElementById('gridStatus')

				if (participantArea && toolbar) {
					const participantRect = participantArea.getBoundingClientRect()
					const toolbarRect = toolbar.getBoundingClientRect()

					// Check if there's proper spacing
					const gap = toolbarRect.top - participantRect.bottom

					if (Math.abs(gap) < 5) {
						// Allow 5px tolerance
						gridStatus.className = 'status success'
						gridStatus.textContent =
							'‚úÖ Grid height fix appears to be working correctly!'
					} else {
						gridStatus.className = 'status error'
						gridStatus.textContent = `‚ùå Grid height issue detected. Gap between participant area and toolbar: ${gap}px`
					}
				}
			})
		</script>
	</body>
</html>
